# 价格分计算修复总结

## 问题描述

用户指出评标规则的价格分计算存在问题：
- 当前系统没有按照正确的评标规则计算价格分
- 价格分应该按照公式：**投标报价得分＝（评标基准价/投标报价）×40%×100**
- 价格分不能单独计算，需要等所有投标方分析完成后进行综合计算

## 修复内容

### 1. 修正价格分计算逻辑

#### 1.1 更新 `modules/price_manager.py`
- 修正了 `calculate_project_price_scores` 方法
- 实现了正确的评标基准价计算逻辑
- 按照公式：`(min_price / price) * price_max_score` 计算价格分

#### 1.2 创建新的价格分计算器 `modules/price_score_calculator.py`
- 实现了 `PriceScoreCalculator` 类
- 支持在所有投标方分析完成后进行综合价格分计算
- 包含以下主要方法：
  - `calculate_project_price_scores()`: 计算项目的价格分
  - `_extract_price_from_result()`: 从分析结果中提取价格信息
  - `_find_price_in_scores()`: 递归查找价格分项
  - `_calculate_price_scores()`: 根据评标规则计算价格分
  - `_update_price_scores_in_db()`: 更新数据库中的价格分

### 2. 修改智能投标分析器

#### 2.1 更新 `modules/intelligent_bid_analyzer.py`
- 添加了价格分特殊处理逻辑
- 新增方法：
  - `_is_price_criteria()`: 检查是否是价格分项
  - `_handle_price_criteria()`: 处理价格分项，只提取价格信息，不进行评分
- 价格分项在分析时只提取价格信息，分数设为0，等待后续综合计算

### 3. 添加后端API接口

#### 3.1 在 `main.py` 中添加新的API端点
- `POST /api/projects/{project_id}/recalculate-price-scores`: 重新计算项目的价格分
- 检查所有投标方是否已完成分析
- 调用价格分计算器进行综合计算
- 更新数据库中的价格分和总分

### 4. 更新前端界面

#### 4.1 在 `static/js/main.js` 中添加功能
- 添加"重新计算价格分"按钮
- 实现 `recalculatePriceScores()` 函数
- 提供用户友好的确认对话框和结果展示
- 计算完成后自动刷新结果页面

### 5. 更新项目文档

#### 5.1 更新 `项目需求与架构说明.md`
- 在评分计算引擎部分添加了价格分综合计算规则（强制性遵守）
- 添加了新的技术架构模块说明
- 更新了接口设计部分，添加价格分综合计算接口

## 技术实现细节

### 价格分计算流程

1. **分析阶段**：
   - 智能投标分析器识别价格分项
   - 只提取价格信息，不进行评分计算
   - 将价格信息保存在 `extracted_price` 字段中

2. **综合计算阶段**：
   - 等所有投标方分析完成后
   - 调用价格分计算器
   - 找到最低价格作为评标基准价
   - 按照公式计算所有投标方的价格分
   - 更新数据库中的价格分和总分

3. **前端展示**：
   - 提供"重新计算价格分"按钮
   - 用户确认后调用API
   - 显示计算结果和更新后的排名

### 评标规则实现

严格按照用户提供的评标规则：
- 满足招标文件要求且投标报价最低的投标报价为评标基准价，其价格分为满分
- 其他投标人的价格分统一按照公式计算：**投标报价得分＝（评标基准价/投标报价）×40%×100**
- 针对每个不同的招标文件，价格分都需要这样综合计算

## 使用说明

1. **正常分析流程**：
   - 上传招标文件和投标文件
   - 系统自动分析所有投标方
   - 价格分项会显示"价格分需要等所有投标方分析完成后综合计算"

2. **重新计算价格分**：
   - 等所有投标方分析完成后
   - 点击"重新计算价格分"按钮
   - 确认操作
   - 系统自动计算并更新价格分和排名

3. **结果查看**：
   - 在汇总表中查看更新后的价格分
   - 在详细视图中查看价格分计算详情
   - 在评标办法表格中查看最终结果

## 注意事项

1. **必须等所有投标方分析完成**：价格分计算需要所有投标方的价格信息
2. **评标基准价确定**：系统自动找到最低有效价格作为评标基准价
3. **公式应用**：严格按照招标文件规定的公式计算价格分
4. **数据更新**：重新计算后会自动更新总分和排名

## 测试建议

1. 上传包含价格分项的招标文件
2. 上传多个投标文件
3. 等待所有分析完成
4. 点击"重新计算价格分"按钮
5. 验证价格分计算是否正确
6. 检查总分和排名是否更新

## 文件清单

### 新增文件
- `modules/price_score_calculator.py`: 价格分计算器

### 修改文件
- `modules/price_manager.py`: 修正价格分计算逻辑
- `modules/intelligent_bid_analyzer.py`: 添加价格分特殊处理
- `main.py`: 添加价格分重新计算API
- `static/js/main.js`: 添加前端价格分计算功能
- `项目需求与架构说明.md`: 更新文档说明

所有修改都已完成，系统现在能够正确处理价格分的综合计算。
