# AI_env2 项目需求与架构说明 (v3.6 整理版)

## 1. 项目概述

### 1.1 项目背景
AI_env2 是一个基于人工智能的投标文件评估系统，旨在通过自动化分析和评分提高评标效率和准确性。

### 1.2 目标用户
- 招标代理机构
- 政府采购部门
- 企业采购部门
- 需要处理大量投标文件的组织

### 1.3 核心问题
1. 人工评标效率低、耗时长
2. 评分规则提取和应用容易出错
3. 投标文件内容复杂，需要OCR和语义理解能力
4. 价格评分规则复杂，需要智能解析和计算

## 2. 系统功能

### 2.1 主要功能
1. 上传招标文件和投标文件（PDF格式）
2. 自动提取评分规则
3. 使用本地AI模型（Ollama + qwen3）进行智能分析和评分
4. 展示评估结果汇总表
5. 提供详细的数据可视化分析（图表、可切换视图的详细表格）
6. 支持历史记录查看
7. 智能价格分计算

### 2.2 关键技术特性
- 支持中文OCR识别
- 使用本地AI模型保障数据隐私
- 支持价格分、技术分等多维度评分计算
- 智能解析复杂评分规则
- PDF文本缓存优化，避免重复OCR处理
- 清晰的多层表头结果展示与深入的数据分析功能

## 3. 技术架构

### 3.1 整体架构（更新）
基于 FastAPI 的前后端一体化架构，分层更清晰，并为路由拆分预留结构：
- **前端**：HTML/CSS/JavaScript + Jinja2 模板引擎 + Chart.js（仅在需要页面加载）
- **后端**：Python 3.10+ + FastAPI + Uvicorn
- **数据库**：SQLite（tender_evaluation.db）
- **AI模型**：Ollama 运行 qwen3:latest 模型
- **PDF处理**：pdfplumber、PyPDF2、PyMuPDF(fitz)、pikepdf
- **OCR**：Tesseract OCR（含中文语言包）
- （预留）`routes/`：将把 `main.py` 中路由分拆为 `projects.py`、`analysis.py`、`config.py` 等模块，采用 FastAPI `APIRouter` 统一挂载。

### 3.2 设计模式
- 工厂模式（用于模块初始化）
- 单例模式（数据库连接）
- 策略模式（评分规则提取与分析）
- 混入模式（功能模块化）

### 3.3 架构特点
- 分层架构（数据访问层、业务逻辑层、表示层）
- 模块化设计（评分规则提取、价格分计算、AI分析等独立模块）
- 向后兼容的模块化重构，单个文件不超过800行

## 4. 核心模块

### 4.1 数据库模块 (modules/database.py)
使用 SQLAlchemy ORM 实现数据库操作，主要数据表：
- **TenderProject**：招标项目信息
- **BidDocument**：投标文件信息
- **AnalysisResult**：分析结果
- **ScoringRule**：评分规则
- **ScoreModificationHistory**：评分修改历史
- **ProjectAuditLog**：项目审计日志

### 4.2 评分规则提取系统 (modules/scoring_extractor/)
模块化重构后的评分规则提取系统，负责从招标文件中解析出评分规则并存入数据库。

### 4.3 价格管理模块 (modules/price_manager.py)
- 价格信息提取和处理
- 价格分计算

### 4.4 智能投标分析模块 (modules/intelligent_bid_analyzer.py)
- 投标文件智能分析
- AI评分处理
- 价格提取和计算
- 进度跟踪和数据库更新

### 4.5 其他核心模块
- **PDF处理**：文本提取、并行页级提取、OCR处理、缓存机制优化（`modules/pdf_processor.py`）
- **结果展示**：动态汇总表（双层表头）生成（`modules/summary_generator.py`）
- **本地AI分析**：本地 AI 模型调用（`modules/local_ai_analyzer.py`）
- **投标方识别**：整合正则/AI/章节锚点/表格回退的统一流程（`modules/bidder_name_extractor.py`）

## 5. 关键技术实现

### 5.1 评分规则提取优化
- **表格结构识别**：增强单元格内容合并逻辑。
- **分数识别**：添加有效性验证。
- **章节提取**：改进边界检测，确保只提取"评标办法"相关章节。

### 5.2 价格评分规则处理（更新）
- **智能解析**：不使用正则表达式提取价格计算公式的方法，将存储评标规则的表格中的最后一行关于价格的全部单元格的内容合成一个完整的价格评价规则，然后把这个评价规则发给AI大模型，要求大模型根据价格评价规则生成价格计算公式，返回给调用函数，保存到数据库。日志仅在最终价格分计算阶段打印必要信息，规则提取阶段不再打印完整Prompt/响应以避免重复。
- **公式存储**：数据库支持价格计算公式存储。
- **强约束**：不允许使用默认价格计算公式。若无法从评标办法中获得明确公式或AI生成失败，则价格分不计算，并在汇总中标注。

### 5.3 性能优化
- **PDF缓存**：使用文件哈希+元信息作为缓存标识，避免重复处理。
- **并发提取**：页级并发提取，带页超时与总超时控制。
- **价格提取**：价格一览表特殊处理；大小写金额对照验证；新增“保证金”独立提取并行级过滤，避免与总价混读（`modules/enhanced_price_extractor.py`）。

### 5.4 结果展示优化（更新）
- **汇总表**：
    - **多层表头**：严格确保父项（`Parent_Item_Name`）在第一行，子项（`Child_Item_Name`）在第二行。父项单元格按所含子项数量设置 `colspan`；“排名”“投标人”“价格分”“总分”四列设置 `rowspan=2`。
    - **内容可读性**：投标人名称和表头子项均实现缩略显示，并通过悬停提示显示完整内容。
    - **水平滚动**：当表格列数过多时，自动出现水平滚动条。
    - **数据范围**：汇总表仅展示当前 `project_id` 下的数据，任何查询与渲染必须显式按 `project_id` 过滤，不得混入其它项目记录。
- **详细分析视图（模态框）**：
    - **价格与得分图表**：以条形图形式，直观对比各投标方的投标报价和最终价格得分（历史页模态框）。
    - **详细评分表格**：提供一组详细表格，按投标方展开展示：
        - **按子项显示**：展示每个投标人在每一条具体评分细则（`Child_Item_Name`）上的得分。
        - **按父项汇总**：自动将各子项得分按其所属的父项（`Parent_Item_Name`）进行加总，展示各投标人在评分大项上的表现。

## 6. 数据处理流程（更新）

1.  **初始化上传（新增）**：上传招标与投标文件，后端快速识别投标人名称并返回前端确认可编辑清单。
2.  **确认名称并启动分析（新增）**：前端确认后，写回数据库并启动后台分析与价格分计算。
3.  **结果呈现**：在前端生成汇总表。用户可点击"详细分析"按钮，查看价格对比图表和可切换视图的详细评分表。

## 7. 开发与部署

### 7.1 环境要求
- **开发**：Python 3.10+、Tesseract OCR（中文语言包）、Ollama（qwen3模型）
- **部署**：FastAPI应用（支持Gunicorn + Uvicorn），确保Ollama服务运行

### 7.2 搭建步骤（更新）
```bash
git clone <repository_url>
cd AI_env2
pip install -r requirements.txt
uvicorn main:app --reload  # 或 python main.py
```

## 8. 技术约束与规范

### 8.1 代码规范
- 遵循 Python 标准编码规范，模块化设计。
- 保持代码整洁，单个文件不超过800行。

### 8.2 性能与安全
- AI分析耗时取决于硬件性能，使用本地模型保障数据隐私。
- 文件上传需要验证格式与大小。

### 8.3 数据结构与处理规范（更新）

#### 8.3.1 评分规则父子项关系处理
- 必须正确区分Parent_Item_Name（父项）和Child_Item_Name（子项）的关系
- 父项：Parent_Item_Name不为空，Child_Item_Name为空
- 子项：Parent_Item_Name和Child_Item_Name都不为空
- 构建评分规则树时应遵循的顺序：
  - 首先识别父项规则
  - 然后处理子项规则
  - 最后建立正确的父子项关联关系

#### 8.3.2 表头生成规范（更新）
- 表头为双层结构：第一行显示 `Parent_Item_Name`（父项），第二行显示 `Child_Item_Name`（子项）。
- 父项单元格需根据其下属子项数量设置 `colspan` 进行合并。
- “排名”“投标方”“价格分”“总分”四列设置 `rowspan=2`。
- 子项列头显示简称与满分，完整内容通过悬停提示显示。

前端从动态汇总接口获取的数据结构建议：
```
{
  scoring_items: {
    "父项A": [{ name: "子项A1", max_score: 10 }, { name: "子项A2", max_score: 5 }],
    "父项B": [{ name: "子项B1", max_score: 20 }]
  },
  rows: [
    { bidder_name: "投标人1", scores: [..对齐各子项..], price_score: 12.34, total_score: 87.65 },
    ...
  ]
}
```

#### 8.3.3 数据展示要求
- 数据行对应Child_Item_Name显示具体得分
- 价格分单独列为一列
- 总分计算包括所有Child_Item_Name得分和价格分
- 从analysis_result表的detailed_scores字段读取数据
- detailed_scores字段结构要求：
  - Parent_Item_Name：评分项父项名称
  - Child_Item_Name：评分项子项名称
  - score：AI模型给出的评分值
  - reason：AI模型给出的分析评论

#### 8.3.4 价格计算公式提取规范
- 价格计算公式从评标办法章节所在的表格中提取
- 价格项通常位于表格的最后一行
- 该行的"评价标准"单元格一般是空的，因为价格项只有父项没有子项
- 该行的第二列单元格本应该是子项的内容，但实际上内容是价格计算的方法
- 该单元格的内容就是要发送到AI大模型生成价格计算公式的内容
- 系统将该描述内容发送给AI大模型分析，提取或推断出价格计算公式
- AI分析完成后，将公式保存在数据库的price_formula字段中供后续价格分计算使用
（补充）错误处理与日志：在价格分计算阶段打印必要信息；规则提取阶段避免打印完整Prompt/响应，减少噪音。无法得到明确公式时严格禁止默认公式，并在汇总中标注“价格分未计算”。

#### 8.3.5 总分计算规范
- 总分计算必须只包含Child_Item_Name对应的实际得分
- 计算流程规范：
  - 遍历每个子项得分并累加
  - 单独处理价格分
  - 使用计算得出的总分而不是直接使用数据库存储的总分
  - 在处理评分数据时，必须确保：
    - 只计算子项得分
    - 避免重复计算或错误计算
    - 区分价格分和其他评分项

#### 8.3.6 数据结构要求
- detailed_scores字段应是一个数组对象
- 数组中的每个元素应是一个字典对象，包含以下键：
  - Parent_Item_Name：评分项父项名称
  - Child_Item_Name：评分项子项名称
  - score：AI模型给出的评分值
  - reason：AI模型给出的分析评论

#### 8.3.7 数据处理规范
- 在处理detailed_scores数据时，应同时支持新旧两种数据格式
- 保持向后兼容性，确保旧数据格式仍可正常工作

#### 8.3.8 价格规则处理规范
- 价格规则应统一计算所有投标人的价格分，而不是针对单个投标人计算
- 在处理评分规则时，应明确区分价格规则和其他评分规则
- 对于价格规则的处理逻辑应独立封装，确保只计算一次
- 在价格分计算完成后，应确保正确保存相关结果
（新增）项目隔离与一致性：
- （新增）统一计算与批量更新：
  - 价格分的计算在所有投标人完成评分分析后、项目级统一执行一次；
  - 数据库更新一次性批量写入当前项目下所有投标人的价格分与受影响的总分；
  - 禁止在单个投标人的分析流程中分别计算/分别保存价格分，避免重复与不一致。
- 价格分计算与更新严格作用于当前 `project_id`。查询 `AnalysisResult`、`ScoringRule`、投标人报价等数据时，必须显式按 `project_id` 过滤。
- 更新价格分时，需仅更新当前项目下的记录，严禁依据投标人名称跨项目匹配。
- 同一项目中，同一 `bid_document_id` 仅保留一条分析结果；在写入前应删除该项目下该文档的旧记录以避免重复与混杂。
- 汇总接口和结果接口返回的数据必须仅包含当前 `project_id` 的记录。

### 8.4 前端展示规范（更新）
- 为提升表格内容的可读性和用户体验，前端表格应实现以下优化：
- 添加水平滑动条：当表格内容宽度超过容器宽度时，自动显示水平滚动条。
- 表头自动换行：表头支持自动换行与悬停完整提示。
- 模态框：历史页详情弹窗展示图表与各投标方详细表。

## 9. 项目演进历程

- **v1.0 - v2.0**：完成基础框架、功能优化和AI集成。
- **v3.0**：重点提升用户体验，包括PDF缓存、价格提取准确性、多层表头等。

## 10. 测试与验证
- 功能完整性、数据准确性、UI交互、向后兼容性测试。

## 11. 未来改进方向
- 增强AI模型准确性，优化性能。
- 增加测试用例，完善错误处理。
- 支持更多文件格式，增强UI交互。

## 12. 版本更新记录

### 12.1 v3.3 更新 (2025-09-14)
- **后端**：调整 `detailed_scores` 字段的JSON结构为键值对字典，与价格分计算解耦。
- **前端**：初步重构汇总表格，修复了因后端数据结构变更导致的JS错误。

### 12.2 v3.4 审查与优化 (2025-09-14)
- **前端**：通过JS和CSS修复，彻底实现了双层表头、内容缩略、悬停提示和水平滚动条功能。
- **文档**：同步更新功能描述，并结构化版本记录。

### 12.3 v3.5 数据可视化增强 (2025-09-14)
- **前端**：
    - **引入Chart.js库**：为项目添加了图表绘制能力。
    - **实现详细分析模态框**：新增了"图表与详细分析"功能，通过模态框展示。
    - **价格对比图表**：在新模态框中，增加了投标报价与价格得分的条形对比图。
    - **可切换评分表**：实现了详细评分表，并提供"按子项/父项"切换视图的功能，便于深度分析。
- **文档**：将新增的数据可视化功能更新到项目需求和功能说明中。

### 12.4 v3.6 评分规则与表格展示优化 (2025-09-14)
- **后端**：
    - 修正了result_display.py和summary_generator.py中的数据处理逻辑，确保正确处理detailed_scores字段中的父子项关系
    - detailed_scores字段现在是一个数组对象，每个元素是一个字典对象，包含Parent_Item_Name、Child_Item_Name、score、reason键
    - 修复了总分计算逻辑，确保只计算子项得分和价格分

### 12.5 v3.7 价格规则处理优化 (2025-09-14)
### 12.6 v3.8 数据一致性与展示修正 (2025-09-15)
### 12.7 v3.9 架构与体验优化 (2025-09-17)
- 新增“名称确认”两步流程：`/api/init-upload` 与 `/api/projects/{id}/start-analysis`；前端先确认可编辑投标人名称再开始分析。
- 历史页详情新增图表与详细表，并修复“价格分/总分”表头缺失。
- 名称提取整合：在单一流程内融合正则→AI→表格回退→章节锚点回退，新增“制造商名称/制造厂家/生产厂家”字段的回退提取。
- 保证金提取：避免与总价混读，行级过滤；为接入价格分计算预置扩展点。
- **文档**：
  - 明确禁止价格分默认公式回退；缺公式时不计算价格分并在汇总中标注。
  - 明确双层表头规范（父/子两层，四固定列rowspan=2，父项按子项合并列）。
  - 新增项目隔离与一致性规范：所有查询/更新必须显式按 `project_id` 过滤；同一项目+同一 `bid_document_id` 仅保留一条分析结果；汇总/结果接口仅返回当前项目数据。
- **后端（说明变更）**：规则落表时父项写 `Parent_Item_Name`，子项写 `Child_Item_Name` 并携带父项名；价格分计算仅基于当前项目的 `AnalysisResult` 且一次性批量更新；写入分析结果前清理当前项目下对应文档的旧记录；规则提取阶段不再打印完整AI Prompt/响应，避免重复日志。
- **后端**：
    - 修复了价格规则重复计算的问题，确保价格规则只计算一次而不是对每个投标人重复计算
    - 为BidDocument数据模型添加了price_extraction_attempts、price_extraction_error和price_extracted字段，用于跟踪价格提取状态
    - 重构了价格分计算逻辑，改为统一计算所有投标人的价格分
- **数据库**：
    - 更新了BidDocument表结构，添加了价格提取相关的跟踪字段
