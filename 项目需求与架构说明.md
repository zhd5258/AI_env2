# AI_env2 项目需求与架构说明 (v2.0)

## 1. 项目概述

### 1.1 项目背景
AI_env2 是一个基于人工智能的投标文件评估系统，旨在通过自动化分析和评分提高评标效率和准确性。

### 1.2 目标用户
- 招标代理机构
- 政府采购部门
- 企业采购部门
- 需要处理大量投标文件的组织

### 1.3 核心问题
1. 人工评标效率低、耗时长
2. 评分规则提取和应用容易出错
3. 投标文件内容复杂，需要OCR和语义理解能力
4. 价格评分规则复杂，需要智能解析和计算

## 2. 系统功能

### 2.1 主要功能
1. 上传招标文件和投标文件（PDF格式）
2. 自动提取评分规则
3. 使用本地AI模型（Ollama + qwen3）进行智能分析和评分
4. 展示评估结果
5. 支持历史记录查看
6. 智能价格分计算

### 2.2 关键特性
1. 支持中文OCR识别
2. 使用本地AI模型进行处理，保障数据隐私
3. 支持价格分、技术分等多维度评分计算
4. 智能解析复杂的评分规则，特别是价格评分公式
5. 支持从数据库读取价格计算公式和变量定义进行动态评分计算

## 3. 技术架构

### 3.1 整体架构
基于 FastAPI 的前后端一体化架构，前端使用 Jinja2 模板引擎，后端使用 Python 实现业务逻辑。

### 3.2 技术选型
#### 前端
- HTML/CSS/JavaScript
- Jinja2 模板引擎

#### 后端
- Python 3.10+
- FastAPI
- Uvicorn

#### 数据库
- SQLite（tender_evaluation.db）

#### AI模型
- Ollama 运行 qwen3:latest 模型

#### PDF处理
- pdfplumber、pypdf2、pikepdf

#### OCR
- Tesseract OCR（含中文语言包）

#### 依赖管理
- pip + requirements.txt

### 3.3 架构模式
1. MVC（Model-View-Controller）模式（通过 FastAPI + Jinja2 实现）
2. 分层架构（数据访问层、业务逻辑层、表示层）
3. 模块化设计（评分规则提取、价格分计算、AI分析等独立模块）

### 3.4 设计模式
1. 工厂模式（用于模块初始化）
2. 单例模式（数据库连接）
3. 策略模式（评分规则提取与分析）
4. 混入模式（功能模块化）

## 4. 核心模块介绍

### 4.1 数据库模块 (modules/database.py)
- 使用 SQLAlchemy ORM 实现数据库操作
- 主要数据表：
  - TenderProject：招标项目信息
  - BidDocument：投标文件信息
  - AnalysisResult：分析结果
  - ScoringRule：评分规则（包含价格计算公式字段）
  - ScoreModificationHistory：评分修改历史
  - ProjectAuditLog：项目审计日志

### 4.2 评分规则提取模块 (modules/scoring_extractor/)
模块化重构后的评分规则提取系统，包含以下子模块：

#### 4.2.1 核心模块 (core.py)
- IntelligentScoringExtractor 类定义
- 模块入口点和主要协调逻辑

#### 4.2.2 文本分析模块 (text_analyzer.py)
- 从文本中提取评分规则
- 章节识别和内容提取
- 改进的章节边界检测逻辑
- 评分项名称清理和验证

#### 4.2.3 表格分析模块 (table_analyzer.py)
- 专门处理表格格式的评分规则
- 改进的单元格内容合并逻辑
- 处理被换行符分割的单元格内容
- 价格评分规则特殊处理
- 使用AI分析价格计算公式

#### 4.2.4 AI分析模块 (ai_analyzer.py)
- 使用本地AI模型辅助评分规则提取
- 复杂文本内容的语义理解

#### 4.2.5 结构处理模块 (structure_handler.py)
- 评分规则层级结构构建
- 重复规则检测和去重
- 总分验证和调整

#### 4.2.6 默认规则模块 (default_rules.py)
- 默认评分规则定义
- 规则格式转换

#### 4.2.7 数据库处理模块 (db_handler.py)
- 评分规则保存到数据库
- 支持价格计算公式存储

#### 4.2.8 工具模块 (utils.py)
- 辅助函数集合
- 评分项名称清理
- 相似性判断
- 分数有效性验证

### 4.3 价格管理模块 (modules/price_manager.py)
- 价格信息提取和处理
- 价格分计算
- 支持从评分规则中读取价格计算公式

### 4.4 价格评分计算器模块 (modules/price_score_calculator.py)
- 综合价格分计算
- 从数据库读取价格计算公式和变量定义
- 智能解析价格评分规则
- 支持多种价格计算方法

### 4.5 其他核心模块
- modules/pdf_processor.py：PDF 文件处理
- modules/local_ai_analyzer.py：本地 AI 模型调用
- modules/intelligent_bid_analyzer.py：投标文件分析

## 5. 关键技术改进

### 5.1 评分规则提取优化
1. **表格结构识别改进**：
   - 增强了单元格内容合并逻辑，正确处理被换行符分割的单元格
   - 改进了表格结构识别，更准确地解析行列关系
   - 避免了不同评分项之间的错误连接

2. **分数识别优化**：
   - 添加了分数有效性验证机制，限制分数范围（0-100）和格式（整数或一位小数）
   - 避免了错误识别如1.6分这样的非标准分值
   - 特殊处理价格分，确保只识别合理的高分值（通常大于10分）

3. **章节提取优化**：
   - 改进了章节提取逻辑，确保只提取"评标办法"相关章节
   - 增强了章节边界检测逻辑，更准确地识别章节开始和结束位置
   - 当找不到明确的评标章节时返回空字符串，而不是使用全文

### 5.2 价格评分规则处理优化
1. **价格计算公式智能解析**：
   - 识别表格中最后一行的价格评分规则
   - 提取价格计算描述并进行格式化（去除回车符、换行符，转换中文标点为英文标点）
   - 将格式化后的内容交给AI大模型分析，生成价格计算公式和变量定义

2. **价格计算公式存储**：
   - 在数据库 ScoringRule 表中添加 price_formula 字段
   - 支持保存价格计算公式和变量定义

3. **动态价格分计算**：
   - 从数据库读取价格计算公式和变量定义
   - 根据价格评分规则进行综合价格分计算
   - 支持多种价格计算方法（自定义公式计算、AI辅助计算、默认方法）

### 5.3 模块化重构
1. **模块拆分**：
   - 将庞大的 intelligent_scoring_extractor.py 文件拆分为多个专门的模块
   - 每个模块都有明确的职责，遵循单一职责原则
   - 提高了代码的可维护性和可读性

2. **向后兼容性**：
   - 保持了原有的导入方式，确保现有代码无需修改即可继续工作
   - 通过主模块文件统一导出接口

## 6. 数据处理流程

### 6.1 评分规则提取流程
1. 上传招标文件
2. 提取"评标办法"章节内容
3. 分析文本和表格结构
4. 提取评分规则（包括价格评分规则）
5. 使用AI分析复杂的价格计算公式
6. 构建评分规则层级结构
7. 保存到数据库

### 6.2 价格分计算流程
1. 提取各投标方的价格信息
2. 从数据库读取价格评分规则和计算公式
3. 解析价格计算公式和变量定义
4. 根据公式计算各投标方的价格分
5. 更新数据库中的价格分和总分

## 7. 开发环境

### 7.1 必需工具
- Python 3.10+
- Tesseract OCR（含中文语言包）
- Ollama（运行 qwen3 模型）
- pip

### 7.2 可选工具
- Git（用于版本控制）

### 7.3 搭建开发环境
```bash
git clone <repository_url>
cd AI_env2
pip install -r requirements.txt
```

### 7.4 本地开发
```bash
uvicorn main:app --reload
```

## 8. 部署说明
- 可部署为 FastAPI 应用（支持 Gunicorn + Uvicorn）
- 需确保 Ollama 服务运行
- 需配置 Tesseract OCR 环境变量

## 9. 技术约束

### 9.1 代码规范
- 遵循 Python 标准编码规范
- 模块化设计，职责分离
- 详细的日志记录，便于问题追踪

### 9.2 性能要求
- AI 分析耗时较长，取决于文档大小和机器性能
- OCR 处理中文 PDF 文件可能影响性能

### 9.3 安全要求
- 使用本地模型处理数据，保障数据隐私
- 上传文件存储在本地 uploads/ 目录

### 9.4 已知问题
- AI 分析和评分规则提取准确性可能不稳定
- 中文 OCR 识别效果依赖于图像质量
- 项目为原型系统，未经过完整测试

## 10. 项目演进历史

### 10.1 第一阶段：基础框架搭建
- 实现基本的文件上传和处理功能
- 建立数据库结构
- 实现基础的评分规则提取

### 10.2 第二阶段：功能完善和优化
- 优化评分规则提取算法
- 改进表格结构识别
- 增强价格分计算功能
- 实现模块化重构

### 10.3 第三阶段：智能处理和AI集成
- 集成本地AI模型进行智能分析
- 实现价格计算公式智能解析
- 支持从数据库读取公式进行动态计算

## 11. 测试策略
1. 模块导入验证
2. 功能完整性测试
3. 向后兼容性验证
4. 价格分计算准确性测试
5. AI分析结果验证

## 12. 未来改进方向
1. 增强AI模型的准确性
2. 优化性能，减少处理时间
3. 增加更多的测试用例
4. 完善错误处理和异常恢复机制
5. 支持更多格式的投标文件