# AI智能投标文件评价系统 - 详细需求与实现架构

## 1. 项目概述

### 1.1 项目背景
作为一个Python资深专家和资深专业评标专家，我需要建设的AI智能投标文件评价系统是一个基于人工智能技术的自动化评标平台，旨在提高招投标过程的效率、准确性和公平性。

### 1.2 目标用户
- **主要用户**：招标评标委员会、政府采购部门
- **次要用户**：投标企业（查看评价结果）、项目管理人员
- **管理用户**：系统管理员、评标专家

### 1.3 核心价值
- 提高评标效率：从传统的人工评标数小时缩短到分钟级AI分析
- 确保评标准确性：基于AI语义分析，避免人工疏漏
- 保证评标公平性：标准化评分规则，减少主观因素
- 降低成本：减少人工评标成本和时间投入

### 1.4 文档信息
- **文档版本**：v3.7
- **最后更新**：2025年9月10日
- **维护者**：AI_EV项目组
- **更新内容**：重构评分规则提取逻辑，修复前端显示错误，确保系统稳定性和准确性。

## 2. 核心业务需求

### 2.1 功能性需求

#### 2.1.1 文件管理模块
**需求描述**：支持招标文件和投标文件的上传、分类、处理
**具体功能**：
- 支持PDF格式文件上传（单文件最大1GB）
- 自动文件分类（招标文件/投标文件）
- 大文件分块上传处理
- 文件格式验证和安全检查
- 文件备份和版本管理

**技术实现**：
- 使用FastAPI实现文件上传组件
- 分块上传机制处理大文件
- 文件类型检测和内容验证

#### 2.1.2 智能PDF处理模块
**需求描述**：从PDF文件中准确提取文本内容，支持增强价格识别
**具体功能**：
- 可搜索PDF直接文本提取
- 扫描版PDF的OCR识别（支持中英文）
- 加密PDF文件处理
- 图像PDF转换和文本识别
- 文本内容结构化处理
- **增强价格提取功能**：
  - 智能识别投标报价信息
  - 多价格信息去重和优选
  - 支持总价、合计等关键字段识别
  - 支持上下文语义分析判断是否为总价

**技术实现**：
- 使用PyPDF2、pdfplumber处理可搜索PDF
- 使用Tesseract OCR处理扫描版PDF
- 使用正则表达式提取价格信息
- 使用上下文分析判断价格类型

#### 2.1.3 评分规则提取模块
**需求描述**：从招标文件中自动提取评分标准和规则
**具体功能**：
- 自动识别评分标准表格
- 提取评分项、分值、权重
- 构建评分规则层级结构
- 支持复杂评分规则（父子项结构）

**技术实现**：
- 使用pandas处理Excel格式评分表
- 使用正则表达式提取评分规则
- 构建评分规则树状结构

#### 2.1.4 AI智能分析模块
**需求描述**：基于本地AI模型对投标文件进行智能评分
**具体功能**：
- 使用本地AI模型分析投标文件
- 根据评分规则进行逐项评分
- 生成评分理由和分析摘要
- 支持评分结果人工复核和修改

**技术实现**：
- 使用Ollama运行本地qwen3模型
- 构建评分提示词模板
- 实现AI评分结果解析
- 提供评分结果修改接口

#### 2.1.5 价格分计算模块
**需求描述**：根据招标规则自动计算各投标方的价格分
**具体功能**：
- 从投标文件中提取报价信息
- 根据招标文件中的价格计算公式计算价格分
- 支持多种价格分计算方式
- 价格分自动更新和同步

**技术实现**：
- 使用增强价格提取器提取投标报价
- 实现基于最低价为基准的价格分计算算法
- 支持自定义价格分计算公式
- 价格分与详细评分数据同步更新

#### 2.1.6 结果展示与导出模块
**需求描述**：以直观的方式展示评分结果，支持多种导出格式
**具体功能**：
- 汇总表形式展示所有投标方评分结果
- 支持按总分排序和筛选
- 支持结果导出为CSV格式
- 提供详细的评分分析报告

**技术实现**：
- 使用Jinja2模板引擎渲染结果页面
- 实现动态表格构建和排序功能
- 提供CSV导出功能

### 2.2 非功能性需求

#### 2.2.1 性能需求
- 单个投标文件分析时间不超过30分钟
- 系统支持同时处理5个投标文件
- 页面响应时间不超过3秒

#### 2.2.2 安全需求
- 所有文件处理在本地完成，不上传至任何外部服务器
- 投标文件内容严格保密，不用于任何其他用途
- 系统访问控制（可选）

#### 2.2.3 可靠性需求
- 系统可用性达到99%
- 评分结果可追溯和审计
- 异常处理和错误恢复机制

#### 2.2.4 兼容性需求
- 支持Windows、Linux、macOS操作系统
- 支持主流浏览器（Chrome、Firefox、Edge）
- 支持不同版本的PDF文件格式

## 3. 系统架构设计

### 3.1 整体架构
系统采用单体架构，基于FastAPI构建RESTful服务，前端使用Jinja2模板引擎渲染页面。

```
+------------------+     +-------------------+     +------------------+
|   用户浏览器      |<--->|   FastAPI服务端    |<--->|   本地AI模型      |
+------------------+     +-------------------+     +------------------+
                              |       |
                              v       v
                      +-----------+ +------------+
                      |  SQLite   | |  文件系统   |
                      |  数据库    | |  (上传文件)  |
                      +-----------+ +------------+
```

### 3.2 技术选型
- **后端框架**：FastAPI
- **AI模型**：Ollama qwen3:latest
- **数据库**：SQLite
- **PDF处理**：PyPDF2、pdfplumber、Tesseract OCR
- **前端渲染**：Jinja2模板引擎
- **依赖管理**：pip + requirements.txt

### 3.3 模块划分
```
项目根目录/
├── main.py                 # FastAPI主程序入口
├── modules/                # 核心功能模块
│   ├── database.py         # 数据库模型和操作
│   ├── pdf_processor.py    # PDF文件处理
│   ├── intelligent_scoring_extractor.py  # 评分规则提取
│   ├── intelligent_bid_analyzer.py       # 投标文件分析
│   ├── local_ai_analyzer.py              # 本地AI模型调用
│   ├── price_manager.py                  # 报价管理
│   ├── enhanced_price_extractor.py       # 增强报价提取
│   └── price_score_calculator.py         # 价格分计算
├── templates/              # 前端模板
│   └── index.html
├── static/                 # 静态资源
│   └── js/
│       └── results.js      # 前端结果处理脚本
├── uploads/                # 上传文件目录
├── tender_evaluation.db    # SQLite数据库文件
├── requirements.txt        # Python依赖列表
└── 项目需求与架构说明.md    # 项目文档
```

## 4. 核心业务流程

### 4.1 文件上传流程
1. 用户上传招标文件和投标文件
2. 系统自动识别文件类型并分类存储
3. 触发文件处理流程

### 4.2 评分规则提取流程
1. 解析招标文件中的评分标准表格
2. 提取评分项、分值、权重等信息
3. 构建评分规则树状结构
4. 存储评分规则到数据库

### 4.3 投标文件分析流程
1. 提取投标文件文本内容
2. 根据评分规则逐项分析
3. 调用本地AI模型进行评分
4. 生成评分结果和分析摘要
5. 存储分析结果到数据库

### 4.4 价格分计算流程
1. 从所有投标文件中提取报价信息
2. 根据招标规则确定价格分计算公式
3. 以最低报价为基准计算各投标方价格分
4. 更新数据库中的价格分字段
5. 同步更新详细评分中的价格分项

### 4.5 结果展示流程
1. 从数据库获取评分结果
2. 构建汇总表结构
3. 渲染前端页面展示结果
4. 支持排序、筛选、导出等功能

## 5. 数据库设计

### 5.1 核心数据表

#### 5.1.1 tender_project（招标项目表）
| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | Integer | 主键 |
| project_code | String | 项目编号 |
| name | String | 项目名称 |
| description | String | 项目描述 |
| tender_file_path | String | 招标文件路径 |
| scoring_rules_summary | JSON | 评分规则摘要 |
| created_at | DateTime | 创建时间 |
| status | String | 项目状态 |

#### 5.1.2 bid_document（投标文件表）
| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | Integer | 主键 |
| project_id | Integer | 外键，关联tender_project |
| bidder_name | String | 投标人名称 |
| file_path | String | 投标文件路径 |
| file_size | Integer | 文件大小 |
| upload_time | DateTime | 上传时间 |
| processing_status | String | 处理状态 |
| error_message | String | 错误信息 |

#### 5.1.3 analysis_result（分析结果表）
| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | Integer | 主键 |
| project_id | Integer | 外键，关联tender_project |
| bid_document_id | Integer | 外键，关联bid_document |
| bidder_name | String | 投标人名称 |
| total_score | Float | 总分 |
| price_score | Float | 价格分 |
| extracted_price | Float | 提取的投标报价 |
| detailed_scores | JSON | 详细评分 |
| analysis_summary | String | 分析摘要 |
| analyzed_at | DateTime | 分析时间 |
| scoring_method | String | 评分方式 |
| ai_model | String | AI模型名称 |

#### 5.1.4 scoring_rule（评分规则表）
| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | Integer | 主键 |
| project_id | Integer | 外键，关联tender_project |
| category | String | 分类 |
| criteria_name | String | 评分项名称 |
| max_score | Float | 满分 |
| weight | Float | 权重 |
| description | String | 描述 |
| is_veto | Boolean | 是否为否决项 |

## 6. 价格分计算机制

### 6.1 价格分提取
系统通过以下方式从投标文件中提取价格信息：
1. 使用增强价格提取器识别投标文件中的价格信息
2. 通过上下文语义分析判断是否为总价
3. 对多个价格信息进行去重和优选

### 6.2 价格分计算
系统支持以下价格分计算方式：
1. **默认计算方式**：以最低报价为评标基准价，其价格分为满分，其他投标人的价格分按公式计算：(评标基准价/投标报价) × 价格权重 × 100
2. **自定义计算方式**：根据招标文件中提供的价格分计算公式进行计算

### 6.3 价格分更新
当所有投标文件分析完成后，系统会：
1. 收集所有投标方的报价信息
2. 计算各投标方的价格分
3. 更新数据库中的价格分字段
4. 同步更新详细评分中的价格分项

## 7. 前端展示设计

### 7.1 汇总表结构
汇总表严格按照评标办法表格格式设计，包含以下列：
- 排名：根据总分自动计算
- 投标人：投标人名称
- 评分项：根据评分规则动态生成
- 价格分：特殊标记列，显示各投标方的价格分
- 总分：各评分项得分之和

### 7.2 交互功能
- 支持按任意列排序
- 支持搜索和筛选功能
- 支持结果导出为CSV格式
- 支持重新计算价格分

## 8. 部署与运维

### 8.1 环境要求
- Python 3.8+
- Tesseract OCR（含中文语言包）
- Ollama（运行qwen3模型）
- Windows/Linux/macOS操作系统

### 8.2 部署步骤
1. 安装Python依赖：`pip install -r requirements.txt`
2. 安装Tesseract OCR并配置系统PATH
3. 安装Ollama并拉取qwen3模型：`ollama pull qwen3:latest`
4. 启动服务：`uvicorn main:app --host 0.0.0.0 --port 8000`

### 8.3 运维要点
- 定期备份数据库文件
- 监控AI模型资源使用情况
- 清理过期上传文件
- 监控系统日志

## 9. 测试策略

### 9.1 单元测试
- 核心模块单元测试覆盖率>80%
- 数据库操作测试
- 价格分计算逻辑测试

### 9.2 集成测试
- 文件上传和处理流程测试
- 评分规则提取测试
- 投标文件分析测试
- 价格分计算测试

### 9.3 端到端测试
- 完整评标流程测试
- 前端展示和交互测试
- 结果导出测试

## 10. 风险与应对

### 10.1 技术风险
- **AI评分准确性不足**：通过人工复核机制降低风险
- **PDF处理失败**：提供多种PDF处理方式作为备选
- **OCR识别错误**：通过上下文分析提高识别准确率

### 10.2 业务风险
- **评分规则提取不完整**：提供人工补充评分规则功能
- **价格信息提取错误**：提供价格信息人工校验功能

### 10.3 运维风险
- **AI模型资源消耗大**：监控资源使用情况，必要时升级硬件
- **大文件处理超时**：优化处理算法，增加处理进度显示

## 11. 项目演进历史

### 11.1 第一阶段：基础框架搭建
- 实现文件上传功能
- 完成PDF处理模块
- 建立数据库结构

### 11.2 第二阶段：核心功能实现
- 实现评分规则提取
- 完成AI智能分析
- 实现基本结果展示

### 11.3 第三阶段：功能完善
- 增强价格提取功能
- 实现价格分计算
- 完善前端展示

### 11.4 第四阶段：性能优化
- 优化AI分析性能
- 改进PDF处理效率
- 提升系统稳定性

### 11.5 第五阶段：汇总表功能完善
- 修复汇总表表头结构
- 实现价格分正确显示
- 完善排序和导出功能

### 11.6 第六阶段：价格分功能完善
- 完善价格分提取和计算逻辑
- 实现价格分在前端的正确显示
- 添加重新计算价格分功能
- 确保价格分与总分的同步更新

## 文档版本信息

- **文档版本**：v3.6
- **最后更新**：2025年9月8日
- **维护者**：AI_EV项目组
- **更新内容**：
  - 添加评标办法表格生成功能需求和实现说明
  - 完善汇总表功能实现详解，包括表头修复、价格分显示、排名列、层级结构处理等
  - 新增第五阶段开发里程碑，记录汇总表功能完善工作
  - 完善价格分功能需求和实现说明，包括价格分提取、计算、显示和更新机制
